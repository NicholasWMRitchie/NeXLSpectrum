### How good are the fit uncertainty estimates?

This document looks at two different sets of measured spectra to evaluate how well, the estimated fit uncertainties
match the observed uncertainties.  We are using two materials known to be highly homogeneous - K412 and ADM-6006a
glasses.  To produce a set of spectra that differ only in count statistics, we will subdivide a spectrum into
100 spectra with an effective live-time of 0.01 of the original spectrum livetime.  We expect that we should be
able to compare the "fit-predicted" uncertainties with the "observed distribution" of measured values.

To be clear:
  - "fit-predicted" - Comes from the covariance matrix output from the linear least squares fit
  - "observed distribution" - Calculated as the standard-deviation of the 100 fit values.

We want the ratio of the (observed distribution) / (fit predicted) to be unity or close.  We will call this ratio the
"heterogeneity" (or "hetero" in the fourth column of the `describe(....)` table.)

We then repeat the process on the multiple measured unknown spectra. (4 for K412 and 15 for ADM-6005a)  We expect
the heterogeneity to be one or larger - larger than unity when the sample is not perfectly homogeneous.

```julia
using NeXLSpectrum              # Provides spectrum reading and fitting tools
using NeXLMatrixCorrection      # Provides `quant` to convert k-ratios to mass fraction.
using DataFrames                # Tables
using Latexify
using BenchmarkTools
```




###### K412
Load the spectra, define the fit model and apply it.
```julia
path = joinpath(@__DIR__,"K412 spectra")
unks = map(0:4) do i 
  loadspectrum(joinpath(path, "III-E K412[$i][4].msa"))
end
det = matching(unks[1], 132.0, 10)
frs = references( [
  reference(n"Al", joinpath(path, "Al2O3 std.msa"), mat"Al2O3"),
  reference(n"Mg", joinpath(path, "MgO std.msa"), mat"MgO"),
  reference(n"Fe", joinpath(path, "Fe std.msa"), mat"Fe"),
  reference(n"Si", joinpath(path, "SiO2 std.msa"), mat"SiO2"),
  reference(n"O", joinpath(path, "SiO2 std.msa"), mat"SiO2"),
  reference(n"Ca", joinpath(path, "CaF2 std.msa") ,mat"CaF2")
], det)
# frs is now a FilteredReference[] used to fit the unknowns.

# Split the counts in unks[1] into 100 randomized spectra which will sum to unks[1] then fit them
res = map(subdivide(unks[1], 100)) do s
  fit_spectrum(s, frs)
end
```

```
100-element Vector{FilterFitResult}:
 Sub[III-E K412[0][all],1 of 100]
 Sub[III-E K412[0][all],2 of 100]
 Sub[III-E K412[0][all],3 of 100]
 Sub[III-E K412[0][all],4 of 100]
 Sub[III-E K412[0][all],5 of 100]
 Sub[III-E K412[0][all],6 of 100]
 Sub[III-E K412[0][all],7 of 100]
 Sub[III-E K412[0][all],8 of 100]
 Sub[III-E K412[0][all],9 of 100]
 Sub[III-E K412[0][all],10 of 100]
 ⋮
 Sub[III-E K412[0][all],92 of 100]
 Sub[III-E K412[0][all],93 of 100]
 Sub[III-E K412[0][all],94 of 100]
 Sub[III-E K412[0][all],95 of 100]
 Sub[III-E K412[0][all],96 of 100]
 Sub[III-E K412[0][all],97 of 100]
 Sub[III-E K412[0][all],98 of 100]
 Sub[III-E K412[0][all],99 of 100]
 Sub[III-E K412[0][all],100 of 100]
```




|                           Spectra | k[O K-L3 + 1 other, SiO2] | Δk[O K-L3 + 1 other, SiO2] | k[Fe L3-M5 + 11 others, Fe] | Δk[Fe L3-M5 + 11 others, Fe] | k[Mg K-L3 + 1 other, MgO] | Δk[Mg K-L3 + 1 other, MgO] | k[Al K-L3 + 1 other, Al2O3] | Δk[Al K-L3 + 1 other, Al2O3] | k[Si K-L3 + 2 others, SiO2] | Δk[Si K-L3 + 2 others, SiO2] | k[Ca K-L3 + 3 others, CaF2] | Δk[Ca K-L3 + 3 others, CaF2] | k[Fe K-L3 + 1 other, Fe] | Δk[Fe K-L3 + 1 other, Fe] | k[Fe K-M3 + 3 others, Fe] | Δk[Fe K-M3 + 3 others, Fe] |
| ---------------------------------:| -------------------------:| --------------------------:| ---------------------------:| ----------------------------:| -------------------------:| --------------------------:| ---------------------------:| ----------------------------:| ---------------------------:| ----------------------------:| ---------------------------:| ----------------------------:| ------------------------:| -------------------------:| -------------------------:| --------------------------:|
|  Sub[III-E K412[0][all],1 of 100] |                    0.6748 |                    0.00822 |                      0.0424 |                     0.004349 |                    0.1514 |                   0.001842 |                     0.06846 |                     0.001589 |                      0.3565 |                     0.002897 |                      0.1913 |                     0.002319 |                  0.06467 |                  0.001582 |                   0.07057 |                   0.006762 |
|  Sub[III-E K412[0][all],2 of 100] |                    0.6604 |                   0.008164 |                     0.04532 |                     0.004484 |                    0.1486 |                   0.001835 |                     0.06516 |                     0.001578 |                      0.3517 |                     0.002895 |                      0.1958 |                     0.002333 |                  0.06691 |                  0.001586 |                    0.0557 |                   0.006552 |
|  Sub[III-E K412[0][all],3 of 100] |                    0.6565 |                    0.00815 |                     0.04216 |                     0.004421 |                    0.1489 |                   0.001834 |                     0.06665 |                     0.001577 |                      0.3509 |                     0.002887 |                      0.1938 |                     0.002336 |                  0.06571 |                  0.001583 |                   0.07296 |                    0.00688 |
|  Sub[III-E K412[0][all],4 of 100] |                    0.6508 |                   0.008108 |                     0.04698 |                     0.004361 |                    0.1499 |                    0.00184 |                      0.0645 |                      0.00158 |                      0.3528 |                     0.002898 |                      0.1904 |                     0.002324 |                  0.06695 |                   0.00159 |                   0.07885 |                   0.006839 |
|  Sub[III-E K412[0][all],5 of 100] |                    0.6448 |                    0.00812 |                     0.03851 |                     0.004386 |                    0.1463 |                   0.001825 |                     0.06591 |                     0.001583 |                      0.3489 |                     0.002885 |                       0.198 |                     0.002353 |                  0.06596 |                    0.0016 |                   0.05634 |                   0.006519 |
|  Sub[III-E K412[0][all],6 of 100] |                    0.6596 |                   0.008152 |                     0.04042 |                      0.00431 |                    0.1456 |                   0.001831 |                     0.06973 |                     0.001604 |                      0.3455 |                     0.002874 |                      0.1935 |                     0.002345 |                  0.06748 |                  0.001595 |                   0.07399 |                   0.006583 |
|  Sub[III-E K412[0][all],7 of 100] |                    0.6591 |                   0.008191 |                     0.04252 |                      0.00448 |                    0.1461 |                   0.001826 |                      0.0651 |                     0.001581 |                      0.3507 |                     0.002893 |                      0.1929 |                     0.002332 |                  0.06596 |                  0.001589 |                   0.06905 |                   0.006863 |
|  Sub[III-E K412[0][all],8 of 100] |                    0.6639 |                   0.008128 |                     0.04862 |                     0.004391 |                    0.1505 |                   0.001843 |                     0.06503 |                     0.001578 |                      0.3584 |                     0.002907 |                      0.1909 |                     0.002314 |                  0.07027 |                  0.001597 |                      0.07 |                   0.006679 |
|  Sub[III-E K412[0][all],9 of 100] |                    0.6707 |                   0.008188 |                      0.0377 |                     0.004229 |                    0.1506 |                   0.001841 |                      0.0671 |                     0.001586 |                      0.3548 |                     0.002896 |                       0.191 |                     0.002329 |                  0.06825 |                  0.001591 |                    0.0596 |                   0.006701 |
| Sub[III-E K412[0][all],10 of 100] |                    0.6561 |                   0.008129 |                     0.04088 |                     0.004414 |                    0.1478 |                   0.001832 |                     0.06643 |                     0.001585 |                      0.3547 |                     0.002891 |                      0.1934 |                     0.002321 |                  0.06916 |                  0.001611 |                   0.07996 |                   0.006835 |



|                    variable |    mean |      std | hetero |     min |     q25 |  median |     q75 |     max |
| ---------------------------:| -------:| --------:| ------:| -------:| -------:| -------:| -------:| -------:|
|   k[O K-L3 + 1 other, SiO2] |  0.6556 | 0.009753 |  1.199 |  0.6316 |   0.649 |  0.6562 |  0.6616 |  0.6821 |
| k[Fe L3-M5 + 11 others, Fe] | 0.04192 | 0.003241 | 0.7399 | 0.03419 | 0.03977 | 0.04208 | 0.04389 | 0.05339 |
|   k[Mg K-L3 + 1 other, MgO] |  0.1476 | 0.001981 |   1.08 |  0.1426 |  0.1463 |  0.1473 |  0.1487 |  0.1523 |
| k[Al K-L3 + 1 other, Al2O3] | 0.06703 |  0.00143 | 0.8996 | 0.06323 | 0.06602 | 0.06692 | 0.06798 | 0.07039 |
| k[Si K-L3 + 2 others, SiO2] |   0.351 | 0.002946 |  1.019 |  0.3452 |  0.3487 |   0.351 |  0.3526 |  0.3584 |
| k[Ca K-L3 + 3 others, CaF2] |  0.1922 | 0.002592 |  1.114 |  0.1858 |  0.1905 |  0.1925 |   0.194 |   0.198 |
|    k[Fe K-L3 + 1 other, Fe] | 0.06684 | 0.001379 | 0.8657 | 0.06393 | 0.06599 |  0.0667 | 0.06772 | 0.07054 |
|   k[Fe K-M3 + 3 others, Fe] |  0.0669 |  0.00783 |  1.165 | 0.04417 | 0.06172 | 0.06707 | 0.07214 | 0.08567 |




Repeat the fit for the 4 measured unknowns.
```julia
res= map(unks) do s
  fit_spectrum(s, frs)
end
```

```
5-element Vector{FilterFitResult}:
 III-E K412[0][all]
 III-E K412[1][all]
 III-E K412[2][all]
 III-E K412[3][all]
 III-E K412[4][all]
```




|            Spectra | k[O K-L3 + 1 other, SiO2] | Δk[O K-L3 + 1 other, SiO2] | k[Fe L3-M5 + 11 others, Fe] | Δk[Fe L3-M5 + 11 others, Fe] | k[Mg K-L3 + 1 other, MgO] | Δk[Mg K-L3 + 1 other, MgO] | k[Al K-L3 + 1 other, Al2O3] | Δk[Al K-L3 + 1 other, Al2O3] | k[Si K-L3 + 2 others, SiO2] | Δk[Si K-L3 + 2 others, SiO2] | k[Ca K-L3 + 3 others, CaF2] | Δk[Ca K-L3 + 3 others, CaF2] | k[Fe K-L3 + 1 other, Fe] | Δk[Fe K-L3 + 1 other, Fe] | k[Fe K-M3 + 3 others, Fe] | Δk[Fe K-M3 + 3 others, Fe] |
| ------------------:| -------------------------:| --------------------------:| ---------------------------:| ----------------------------:| -------------------------:| --------------------------:| ---------------------------:| ----------------------------:| ---------------------------:| ----------------------------:| ---------------------------:| ----------------------------:| ------------------------:| -------------------------:| -------------------------:| --------------------------:|
| III-E K412[0][all] |                    0.6556 |                  0.0008134 |                     0.04191 |                    0.0004382 |                    0.1476 |                  0.0001834 |                     0.06703 |                     0.000159 |                       0.351 |                     0.000289 |                      0.1922 |                    0.0002326 |                  0.06683 |                 0.0001593 |                   0.06684 |                  0.0006722 |
| III-E K412[1][all] |                    0.6574 |                  0.0008141 |                     0.04157 |                    0.0004372 |                    0.1475 |                  0.0001835 |                     0.06679 |                     0.000159 |                      0.3502 |                    0.0002888 |                      0.1916 |                    0.0002324 |                  0.06708 |                 0.0001595 |                   0.06738 |                  0.0006721 |
| III-E K412[2][all] |                     0.658 |                  0.0008157 |                     0.04192 |                    0.0004381 |                    0.1479 |                  0.0001838 |                     0.06713 |                    0.0001594 |                      0.3514 |                    0.0002896 |                      0.1922 |                    0.0002329 |                  0.06688 |                 0.0001596 |                   0.06704 |                  0.0006737 |
| III-E K412[3][all] |                    0.6624 |                  0.0008188 |                     0.04146 |                    0.0004379 |                    0.1481 |                  0.0001841 |                      0.0672 |                    0.0001596 |                      0.3522 |                      0.00029 |                      0.1925 |                    0.0002333 |                  0.06682 |                 0.0001598 |                    0.0678 |                  0.0006746 |
| III-E K412[4][all] |                    0.6608 |                  0.0008182 |                     0.04082 |                    0.0004383 |                    0.1482 |                  0.0001841 |                     0.06732 |                    0.0001597 |                      0.3521 |                      0.00029 |                      0.1922 |                    0.0002333 |                  0.06694 |                 0.0001598 |                   0.06648 |                  0.0006739 |



Summary statistics.

|                    variable |    mean |       std | hetero |     min |     q25 |  median |     q75 |     max |
| ---------------------------:| -------:| ---------:| ------:| -------:| -------:| -------:| -------:| -------:|
|   k[O K-L3 + 1 other, SiO2] |  0.6588 |  0.002724 |  3.338 |  0.6556 |  0.6574 |   0.658 |  0.6608 |  0.6624 |
| k[Fe L3-M5 + 11 others, Fe] | 0.04153 | 0.0004496 |  1.027 | 0.04082 | 0.04146 | 0.04157 | 0.04191 | 0.04192 |
|   k[Mg K-L3 + 1 other, MgO] |  0.1478 | 0.0003026 |  1.647 |  0.1475 |  0.1476 |  0.1479 |  0.1481 |  0.1482 |
| k[Al K-L3 + 1 other, Al2O3] | 0.06709 | 0.0002022 |  1.269 | 0.06679 | 0.06703 | 0.06713 |  0.0672 | 0.06732 |
| k[Si K-L3 + 2 others, SiO2] |  0.3514 | 0.0008301 |  2.867 |  0.3502 |   0.351 |  0.3514 |  0.3521 |  0.3522 |
| k[Ca K-L3 + 3 others, CaF2] |  0.1921 |  0.000318 |  1.365 |  0.1916 |  0.1922 |  0.1922 |  0.1922 |  0.1925 |
|    k[Fe K-L3 + 1 other, Fe] | 0.06691 | 0.0001063 | 0.6661 | 0.06682 | 0.06683 | 0.06688 | 0.06694 | 0.06708 |
|   k[Fe K-M3 + 3 others, Fe] | 0.06711 | 0.0005071 | 0.7531 | 0.06648 | 0.06684 | 0.06704 | 0.06738 |  0.0678 |


```julia
@btime fit_spectrum(unks[1], frs)
```

```
1.021 ms (3083 allocations: 514.52 KiB)
III-E K412[0][all]
```





###### AMM-6005a
Repeat using the ADM glass.  Fe is not present in ADM-6005a but we fit it to see what a null result looks like.
```julia
path = normpath(joinpath(@__DIR__, "..","test","ADM6005a spectra"))
unks = map(i->loadspectrum(joinpath(path,"ADM-6005a_$i.msa")),1:15)
al, caf2, fe, ge, si, sio2, ti, zn = map(f->loadspectrum(joinpath(path,"$f.msa")), ("Al std", "CaF2 std", "Fe std", "Ge std", "Si std", "SiO2 std", "Ti trimmed","Zn std"))

det = matching(unks[1], 132.0, 10)

frs = references( [
  reference(n"Al", al, mat"Al" ), #
  reference(n"Ca", caf2, mat"CaF2" ),   #
  reference(n"Fe", fe, mat"Fe" ),    #
  reference(n"Ge", ge, mat"Ge" ),    #
  reference(n"Si", si, mat"Si" ),  #
  reference(n"O", sio2, mat"SiO2" ),  #
  reference(n"Ti", ti, mat"Ti" ),
  reference(n"Zn", zn, mat"Zn" ) 
], det)

ss = 
res= map(subdivide(unks[1], 100)) do s
  fit_spectrum(s, frs)
end
```

```
100-element Vector{FilterFitResult}:
 Sub[ADM-6005a_1,1 of 100]
 Sub[ADM-6005a_1,2 of 100]
 Sub[ADM-6005a_1,3 of 100]
 Sub[ADM-6005a_1,4 of 100]
 Sub[ADM-6005a_1,5 of 100]
 Sub[ADM-6005a_1,6 of 100]
 Sub[ADM-6005a_1,7 of 100]
 Sub[ADM-6005a_1,8 of 100]
 Sub[ADM-6005a_1,9 of 100]
 Sub[ADM-6005a_1,10 of 100]
 ⋮
 Sub[ADM-6005a_1,92 of 100]
 Sub[ADM-6005a_1,93 of 100]
 Sub[ADM-6005a_1,94 of 100]
 Sub[ADM-6005a_1,95 of 100]
 Sub[ADM-6005a_1,96 of 100]
 Sub[ADM-6005a_1,97 of 100]
 Sub[ADM-6005a_1,98 of 100]
 Sub[ADM-6005a_1,99 of 100]
 Sub[ADM-6005a_1,100 of 100]
```




|                    Spectra | k[Ti L3-M1 + 6 others, Ti] | Δk[Ti L3-M1 + 6 others, Ti] | k[O K-L3 + 1 other, SiO2] | Δk[O K-L3 + 1 other, SiO2] | k[Fe L3-M5 + 11 others, Fe] | Δk[Fe L3-M5 + 11 others, Fe] | k[Zn L3-M5 + 11 others, Zn] | Δk[Zn L3-M5 + 11 others, Zn] | k[Ge L3-M5 + 11 others, Ge] | Δk[Ge L3-M5 + 11 others, Ge] | k[Al K-L3 + 1 other, Al] | Δk[Al K-L3 + 1 other, Al] | k[Si K-L3 + 2 others, Si] | Δk[Si K-L3 + 2 others, Si] | k[Ca K-L3 + 3 others, CaF2] | Δk[Ca K-L3 + 3 others, CaF2] | k[Ti K-L3 + 3 others, Ti] | Δk[Ti K-L3 + 3 others, Ti] | k[Fe K-L3 + 1 other, Fe] | Δk[Fe K-L3 + 1 other, Fe] | k[Fe K-M3 + 3 others, Fe] | Δk[Fe K-M3 + 3 others, Fe] | k[Zn K-L3 + 1 other, Zn] | Δk[Zn K-L3 + 1 other, Zn] | k[Zn K-M3 + 3 others, Zn] | Δk[Zn K-M3 + 3 others, Zn] | k[Ge K-L3 + 1 other, Ge] | Δk[Ge K-L3 + 1 other, Ge] | k[Ge K-M3 + 3 others, Ge] | Δk[Ge K-M3 + 3 others, Ge] |
| --------------------------:| --------------------------:| ---------------------------:| -------------------------:| --------------------------:| ---------------------------:| ----------------------------:| ---------------------------:| ----------------------------:| ---------------------------:| ----------------------------:| ------------------------:| -------------------------:| -------------------------:| --------------------------:| ---------------------------:| ----------------------------:| -------------------------:| --------------------------:| ------------------------:| -------------------------:| -------------------------:| --------------------------:| ------------------------:| -------------------------:| -------------------------:| --------------------------:| ------------------------:| -------------------------:| -------------------------:| --------------------------:|
|  Sub[ADM-6005a_1,1 of 100] |                    0.03979 |                     0.01847 |                    0.4911 |                   0.006699 |                           0 |                      0.05178 |                     0.06633 |                     0.001464 |                      0.1789 |                     0.001768 |                  0.02762 |                 0.0005026 |                   0.02149 |                  0.0004995 |                      0.1231 |                     0.001687 |                   0.06298 |                   0.001038 |                  0.00235 |                 0.0006933 |                         0 |                     0.0721 |                   0.1108 |                  0.002723 |                    0.1382 |                    0.01576 |                   0.2633 |                  0.005289 |                    0.2784 |                    0.01904 |
|  Sub[ADM-6005a_1,2 of 100] |                    0.03466 |                      0.0181 |                    0.5047 |                   0.006812 |                    0.005932 |                     0.002824 |                     0.06779 |                     0.001479 |                      0.1762 |                     0.001755 |                  0.02882 |                 0.0004978 |                   0.02152 |                  0.0005032 |                        0.12 |                     0.001693 |                   0.06505 |                   0.001033 |                0.0007142 |                  0.000703 |                         0 |                    0.07099 |                   0.1068 |                  0.002742 |                    0.1364 |                    0.01595 |                   0.2593 |                  0.005218 |                    0.2675 |                     0.0192 |
|  Sub[ADM-6005a_1,3 of 100] |                     0.0119 |                     0.01812 |                    0.4964 |                   0.006833 |                           0 |                      0.05351 |                      0.0687 |                     0.001476 |                      0.1769 |                     0.001754 |                  0.02769 |                 0.0004955 |                   0.02186 |                  0.0005054 |                      0.1221 |                      0.00169 |                   0.06324 |                   0.001027 |                0.0007645 |                  0.000715 |                  0.002875 |                   0.005064 |                   0.1075 |                  0.002706 |                    0.1247 |                    0.01565 |                    0.282 |                  0.005385 |                    0.2553 |                    0.01876 |
|  Sub[ADM-6005a_1,4 of 100] |                   0.003213 |                     0.01808 |                    0.4844 |                   0.006751 |                   0.0004915 |                      0.00285 |                     0.06675 |                     0.001475 |                      0.1777 |                     0.001768 |                    0.028 |                 0.0005002 |                   0.02092 |                  0.0004986 |                      0.1234 |                     0.001682 |                   0.06524 |                   0.001027 |                 0.000916 |                 0.0007002 |                  0.006976 |                   0.005102 |                    0.115 |                  0.002737 |                    0.1355 |                    0.01588 |                   0.2642 |                  0.005256 |                    0.2675 |                    0.01848 |
|  Sub[ADM-6005a_1,5 of 100] |                    0.01945 |                     0.01773 |                    0.4877 |                   0.006754 |                   0.0002066 |                     0.002809 |                     0.06641 |                     0.001472 |                      0.1794 |                     0.001766 |                   0.0274 |                 0.0004981 |                   0.02071 |                  0.0005004 |                       0.121 |                     0.001683 |                   0.05966 |                   0.001018 |                        0 |                   0.02621 |                  0.004308 |                   0.005043 |                   0.1089 |                  0.002674 |                    0.1653 |                    0.01593 |                   0.2763 |                  0.005334 |                    0.2649 |                    0.01935 |
|  Sub[ADM-6005a_1,6 of 100] |                          0 |                      0.1343 |                    0.4792 |                   0.006389 |                    0.004669 |                     0.002829 |                     0.06909 |                     0.001474 |                      0.1777 |                     0.001777 |                  0.02765 |                 0.0005016 |                   0.02151 |                   0.000504 |                        0.12 |                      0.00169 |                     0.062 |                   0.001022 |                0.0005552 |                 0.0006844 |                         0 |                    0.07149 |                   0.1137 |                  0.002747 |                    0.1324 |                    0.01579 |                   0.2605 |                  0.005209 |                    0.2353 |                    0.01892 |
|  Sub[ADM-6005a_1,7 of 100] |                    0.02144 |                     0.01817 |                    0.4946 |                   0.006747 |                    0.002012 |                     0.002769 |                     0.06663 |                     0.001487 |                      0.1805 |                     0.001785 |                   0.0264 |                 0.0004901 |                   0.02145 |                  0.0005001 |                      0.1258 |                     0.001709 |                   0.06547 |                   0.001032 |                0.0005266 |                 0.0007202 |                  0.003074 |                   0.005004 |                   0.1124 |                  0.002693 |                    0.1375 |                    0.01578 |                   0.2689 |                  0.005244 |                    0.2434 |                    0.01832 |
|  Sub[ADM-6005a_1,8 of 100] |                    0.03785 |                     0.01833 |                     0.497 |                   0.006791 |                    0.002617 |                     0.002876 |                     0.06656 |                     0.001454 |                      0.1783 |                     0.001759 |                  0.02873 |                  0.000502 |                   0.02111 |                  0.0005014 |                      0.1228 |                     0.001692 |                   0.06354 |                   0.001023 |                0.0005336 |                 0.0006994 |                         0 |                    0.07004 |                   0.1088 |                  0.002742 |                    0.1109 |                    0.01583 |                   0.2602 |                  0.005269 |                    0.2961 |                    0.01938 |
|  Sub[ADM-6005a_1,9 of 100] |                    0.01875 |                      0.0183 |                    0.5004 |                   0.006772 |                    0.003413 |                     0.002895 |                     0.06436 |                     0.001461 |                      0.1785 |                     0.001753 |                  0.02797 |                 0.0004975 |                   0.02132 |                  0.0004992 |                      0.1217 |                     0.001691 |                   0.06725 |                   0.001047 |                3.557e-05 |                 0.0006965 |                         0 |                    0.07085 |                     0.11 |                  0.002724 |                    0.0934 |                    0.01596 |                   0.2512 |                  0.005277 |                    0.2859 |                    0.01921 |
| Sub[ADM-6005a_1,10 of 100] |                    0.04406 |                      0.0181 |                    0.5025 |                   0.006808 |                           0 |                      0.05165 |                      0.0696 |                     0.001484 |                      0.1803 |                      0.00176 |                  0.02744 |                 0.0004936 |                   0.02074 |                  0.0004955 |                      0.1243 |                     0.001706 |                     0.066 |                   0.001035 |                        0 |                   0.02608 |                   0.01174 |                   0.005274 |                   0.1124 |                  0.002761 |                   0.08306 |                    0.01569 |                   0.2532 |                  0.005189 |                    0.2533 |                    0.01868 |



Summary statistics.

|                    variable |      mean |       std |  hetero |     min |      q25 |    median |       q75 |      max |
| ---------------------------:| ---------:| ---------:| -------:| -------:| --------:| ---------:| ---------:| --------:|
|  k[Ti L3-M1 + 6 others, Ti] |   0.02125 |   0.01765 |  0.4972 |       0 | 0.006676 |    0.0199 |   0.03005 |  0.07814 |
|   k[O K-L3 + 1 other, SiO2] |    0.4877 |  0.009816 |   1.469 |    0.46 |   0.4813 |    0.4881 |    0.4945 |   0.5122 |
| k[Fe L3-M5 + 11 others, Fe] |  0.001311 |  0.001875 | 0.07139 |       0 |        0 | 0.0002671 |   0.00204 | 0.007958 |
| k[Zn L3-M5 + 11 others, Zn] |   0.06813 |   0.00184 |   1.247 | 0.06364 |  0.06674 |   0.06821 |   0.06914 |  0.07305 |
| k[Ge L3-M5 + 11 others, Ge] |    0.1793 |  0.002352 |   1.331 |  0.1743 |   0.1777 |    0.1789 |    0.1808 |   0.1852 |
|    k[Al K-L3 + 1 other, Al] |   0.02803 | 0.0007543 |   1.508 | 0.02608 |  0.02753 |   0.02798 |   0.02848 |  0.03013 |
|   k[Si K-L3 + 2 others, Si] |   0.02145 |  0.000687 |    1.37 | 0.01983 |  0.02106 |   0.02141 |    0.0219 |  0.02346 |
| k[Ca K-L3 + 3 others, CaF2] |    0.1214 |  0.002496 |    1.48 |  0.1148 |   0.1199 |    0.1209 |     0.123 |   0.1274 |
|   k[Ti K-L3 + 3 others, Ti] |   0.06433 |  0.001472 |   1.426 | 0.05966 |  0.06341 |   0.06427 |   0.06525 |  0.06874 |
|    k[Fe K-L3 + 1 other, Fe] | 0.0004357 | 0.0004932 | 0.05111 |       0 |        0 | 0.0004093 | 0.0006618 |  0.00235 |
|   k[Fe K-M3 + 3 others, Fe] |  0.003286 |  0.004442 |  0.1231 |       0 |        0 | 0.0009466 |  0.005763 |    0.019 |
|    k[Zn K-L3 + 1 other, Zn] |    0.1117 |   0.00389 |   1.428 |  0.1027 |   0.1088 |    0.1121 |    0.1146 |   0.1206 |
|   k[Zn K-M3 + 3 others, Zn] |    0.1244 |   0.01707 |   1.087 |  0.0724 |   0.1152 |    0.1227 |    0.1364 |   0.1661 |
|    k[Ge K-L3 + 1 other, Ge] |    0.2634 |  0.007557 |   1.438 |  0.2441 |   0.2585 |     0.263 |     0.268 |    0.282 |
|   k[Ge K-M3 + 3 others, Ge] |    0.2712 |   0.02233 |    1.17 |  0.2221 |   0.2537 |    0.2684 |    0.2894 |     0.33 |




Repeat for the 15 measured spectra.
```julia
res= map(unks) do s
  fit_spectrum(s, frs)
end
```

```
15-element Vector{FilterFitResult}:
 ADM-6005a_1
 ADM-6005a_2
 ADM-6005a_3
 ADM-6005a_4
 ADM-6005a_5
 ADM-6005a_6
 ADM-6005a_7
 ADM-6005a_8
 ADM-6005a_9
 ADM-6005a_10
 ADM-6005a_11
 ADM-6005a_12
 ADM-6005a_13
 ADM-6005a_14
 ADM-6005a_15
```




|      Spectra | k[Ti L3-M1 + 6 others, Ti] | Δk[Ti L3-M1 + 6 others, Ti] | k[O K-L3 + 1 other, SiO2] | Δk[O K-L3 + 1 other, SiO2] | k[Fe L3-M5 + 11 others, Fe] | Δk[Fe L3-M5 + 11 others, Fe] | k[Zn L3-M5 + 11 others, Zn] | Δk[Zn L3-M5 + 11 others, Zn] | k[Ge L3-M5 + 11 others, Ge] | Δk[Ge L3-M5 + 11 others, Ge] | k[Al K-L3 + 1 other, Al] | Δk[Al K-L3 + 1 other, Al] | k[Si K-L3 + 2 others, Si] | Δk[Si K-L3 + 2 others, Si] | k[Ca K-L3 + 3 others, CaF2] | Δk[Ca K-L3 + 3 others, CaF2] | k[Ti K-L3 + 3 others, Ti] | Δk[Ti K-L3 + 3 others, Ti] | k[Fe K-L3 + 1 other, Fe] | Δk[Fe K-L3 + 1 other, Fe] | k[Fe K-M3 + 3 others, Fe] | Δk[Fe K-M3 + 3 others, Fe] | k[Zn K-L3 + 1 other, Zn] | Δk[Zn K-L3 + 1 other, Zn] | k[Zn K-M3 + 3 others, Zn] | Δk[Zn K-M3 + 3 others, Zn] | k[Ge K-L3 + 1 other, Ge] | Δk[Ge K-L3 + 1 other, Ge] | k[Ge K-M3 + 3 others, Ge] | Δk[Ge K-M3 + 3 others, Ge] |
| ------------:| --------------------------:| ---------------------------:| -------------------------:| --------------------------:| ---------------------------:| ----------------------------:| ---------------------------:| ----------------------------:| ---------------------------:| ----------------------------:| ------------------------:| -------------------------:| -------------------------:| --------------------------:| ---------------------------:| ----------------------------:| -------------------------:| --------------------------:| ------------------------:| -------------------------:| -------------------------:| --------------------------:| ------------------------:| -------------------------:| -------------------------:| --------------------------:| ------------------------:| -------------------------:| -------------------------:| --------------------------:|
|  ADM-6005a_1 |                    0.01961 |                    0.001806 |                    0.4876 |                  0.0006731 |                   0.0001192 |                    0.0002801 |                     0.06814 |                    0.0001475 |                      0.1793 |                    0.0001767 |                  0.02803 |                 5.002e-05 |                   0.02145 |                  5.015e-05 |                      0.1214 |                    0.0001687 |                   0.06433 |                  0.0001033 |                0.0002048 |                 6.966e-05 |                  0.001265 |                  0.0005064 |                   0.1117 |                 0.0002725 |                    0.1242 |                    0.00157 |                   0.2634 |                 0.0005252 |                     0.271 |                   0.001901 |
|  ADM-6005a_2 |                    0.02049 |                    0.001807 |                    0.4863 |                   0.000673 |                           0 |                      0.01666 |                     0.06796 |                    0.0001475 |                      0.1797 |                    0.0001767 |                  0.02796 |                 5.001e-05 |                   0.02148 |                   5.01e-05 |                      0.1214 |                    0.0001687 |                   0.06393 |                  0.0001032 |                0.0003342 |                 6.935e-05 |                  0.001418 |                  0.0005071 |                   0.1115 |                 0.0002728 |                    0.1242 |                   0.001569 |                    0.264 |                 0.0005255 |                    0.2779 |                   0.001906 |
|  ADM-6005a_3 |                    0.02104 |                    0.001806 |                    0.4894 |                  0.0006739 |                   0.0002456 |                    0.0002783 |                     0.06801 |                    0.0001478 |                      0.1795 |                    0.0001767 |                  0.02808 |                 5.002e-05 |                   0.02139 |                  5.009e-05 |                      0.1216 |                    0.0001688 |                   0.06404 |                  0.0001033 |                0.0002986 |                 6.974e-05 |                 0.0006342 |                  0.0005059 |                   0.1116 |                 0.0002723 |                    0.1171 |                   0.001568 |                   0.2622 |                 0.0005249 |                    0.2805 |                   0.001906 |
|  ADM-6005a_4 |                    0.01925 |                    0.001807 |                     0.488 |                  0.0006739 |                           0 |                      0.01669 |                     0.06843 |                    0.0001479 |                      0.1795 |                    0.0001768 |                  0.02804 |                 5.007e-05 |                   0.02151 |                  5.018e-05 |                      0.1211 |                    0.0001687 |                   0.06402 |                  0.0001032 |                0.0003314 |                 6.985e-05 |                  0.001286 |                  0.0005073 |                   0.1116 |                 0.0002729 |                    0.1219 |                   0.001568 |                   0.2635 |                 0.0005251 |                    0.2763 |                   0.001907 |
|  ADM-6005a_5 |                    0.01979 |                    0.001807 |                     0.488 |                  0.0006736 |                           0 |                      0.01668 |                      0.0679 |                    0.0001475 |                      0.1793 |                    0.0001767 |                  0.02819 |                 5.006e-05 |                   0.02135 |                  5.011e-05 |                      0.1215 |                    0.0001689 |                   0.06406 |                  0.0001032 |                0.0002726 |                 6.967e-05 |                  0.001403 |                   0.000506 |                   0.1116 |                 0.0002724 |                    0.1223 |                   0.001563 |                   0.2624 |                  0.000525 |                    0.2739 |                   0.001902 |
|  ADM-6005a_6 |                    0.02261 |                    0.001805 |                    0.4892 |                  0.0006731 |                           0 |                      0.01667 |                     0.06812 |                    0.0001476 |                      0.1792 |                    0.0001767 |                  0.02817 |                 5.009e-05 |                   0.02144 |                  5.015e-05 |                      0.1209 |                    0.0001686 |                   0.06397 |                  0.0001033 |                0.0002285 |                 6.936e-05 |                  0.001213 |                  0.0005055 |                   0.1111 |                 0.0002723 |                    0.1236 |                   0.001568 |                   0.2619 |                  0.000525 |                    0.2785 |                   0.001901 |
|  ADM-6005a_7 |                    0.02161 |                    0.001812 |                    0.4897 |                  0.0006748 |                           0 |                      0.01668 |                     0.06787 |                    0.0001475 |                      0.1795 |                    0.0001768 |                  0.02798 |                 5.003e-05 |                    0.0215 |                  5.011e-05 |                      0.1215 |                    0.0001688 |                    0.0642 |                  0.0001033 |                0.0003133 |                 6.951e-05 |                         0 |                    0.02247 |                   0.1111 |                 0.0002731 |                     0.123 |                   0.001573 |                   0.2635 |                 0.0005264 |                    0.2731 |                   0.001902 |
|  ADM-6005a_8 |                    0.01965 |                    0.001808 |                    0.4884 |                  0.0006735 |                   8.944e-05 |                    0.0002781 |                     0.06805 |                    0.0001477 |                      0.1796 |                    0.0001768 |                  0.02812 |                 5.011e-05 |                   0.02156 |                  5.018e-05 |                      0.1215 |                    0.0001687 |                   0.06411 |                  0.0001032 |                0.0002939 |                 6.953e-05 |                 0.0003189 |                  0.0005084 |                   0.1113 |                 0.0002722 |                    0.1239 |                   0.001571 |                   0.2639 |                 0.0005259 |                    0.2782 |                   0.001909 |
|  ADM-6005a_9 |                    0.02078 |                     0.00181 |                    0.4885 |                  0.0006736 |                           0 |                      0.01669 |                     0.06835 |                    0.0001478 |                      0.1791 |                    0.0001769 |                  0.02814 |                 5.007e-05 |                   0.02154 |                  5.016e-05 |                      0.1214 |                    0.0001687 |                   0.06402 |                  0.0001032 |                 0.000302 |                 6.967e-05 |                  0.001483 |                  0.0005078 |                    0.111 |                 0.0002723 |                    0.1197 |                   0.001571 |                   0.2614 |                 0.0005256 |                    0.2768 |                   0.001902 |
| ADM-6005a_10 |                    0.02461 |                    0.001806 |                    0.4877 |                  0.0006734 |                   0.0001256 |                     0.000279 |                     0.06788 |                    0.0001477 |                      0.1797 |                    0.0001768 |                  0.02816 |                 5.006e-05 |                    0.0215 |                  5.016e-05 |                      0.1211 |                    0.0001687 |                   0.06386 |                  0.0001031 |                0.0001826 |                 6.964e-05 |                  0.001759 |                  0.0005073 |                   0.1117 |                 0.0002726 |                     0.126 |                   0.001572 |                   0.2627 |                 0.0005253 |                    0.2751 |                   0.001909 |
| ADM-6005a_11 |                    0.02009 |                    0.001805 |                    0.4883 |                   0.000674 |                   0.0002259 |                    0.0002791 |                      0.0678 |                    0.0001476 |                      0.1797 |                    0.0001768 |                  0.02806 |                 5.006e-05 |                   0.02156 |                  5.017e-05 |                      0.1214 |                    0.0001688 |                   0.06397 |                  0.0001031 |                0.0004916 |                 6.947e-05 |                 0.0008535 |                  0.0005053 |                   0.1115 |                 0.0002721 |                    0.1231 |                   0.001566 |                   0.2633 |                 0.0005256 |                    0.2719 |                   0.001896 |
| ADM-6005a_12 |                    0.02039 |                    0.001812 |                    0.4899 |                  0.0006749 |                           0 |                      0.01669 |                     0.06789 |                    0.0001476 |                      0.1796 |                    0.0001769 |                  0.02801 |                 5.006e-05 |                   0.02151 |                  5.018e-05 |                      0.1213 |                    0.0001688 |                   0.06378 |                  0.0001032 |                0.0003361 |                 6.939e-05 |                  0.001099 |                  0.0005068 |                   0.1113 |                 0.0002729 |                    0.1182 |                   0.001568 |                   0.2624 |                 0.0005259 |                    0.2734 |                   0.001901 |
| ADM-6005a_13 |                     0.0167 |                    0.001813 |                    0.4893 |                  0.0006747 |                   0.0002034 |                    0.0002777 |                     0.06837 |                    0.0001478 |                      0.1794 |                    0.0001768 |                   0.0281 |                     5e-05 |                   0.02145 |                  5.017e-05 |                      0.1216 |                    0.0001687 |                   0.06395 |                  0.0001032 |                0.0003101 |                  6.96e-05 |                         0 |                    0.02247 |                   0.1113 |                 0.0002727 |                     0.126 |                   0.001568 |                   0.2632 |                 0.0005253 |                    0.2795 |                   0.001911 |
| ADM-6005a_14 |                    0.01852 |                     0.00181 |                    0.4895 |                  0.0006742 |                           0 |                      0.01666 |                     0.06805 |                    0.0001478 |                      0.1798 |                    0.0001768 |                  0.02797 |                 5.001e-05 |                   0.02154 |                  5.013e-05 |                      0.1215 |                    0.0001689 |                   0.06388 |                  0.0001033 |                0.0003892 |                 6.958e-05 |                 0.0008041 |                  0.0005066 |                   0.1112 |                 0.0002723 |                    0.1229 |                   0.001569 |                   0.2628 |                 0.0005251 |                    0.2764 |                     0.0019 |
| ADM-6005a_15 |                    0.01902 |                    0.001809 |                    0.4903 |                  0.0006741 |                           0 |                      0.01664 |                     0.06802 |                    0.0001476 |                      0.1799 |                     0.000177 |                  0.02816 |                  5.01e-05 |                   0.02143 |                  5.015e-05 |                      0.1215 |                    0.0001688 |                   0.06409 |                  0.0001032 |                0.0002762 |                 6.947e-05 |                   0.00149 |                  0.0005059 |                   0.1116 |                 0.0002725 |                    0.1225 |                   0.001569 |                   0.2632 |                 0.0005255 |                    0.2724 |                   0.001903 |



Summary statistics.

|                    variable |      mean |       std |   hetero |       min |       q25 |   median |       q75 |       max |
| ---------------------------:| ---------:| ---------:| --------:| ---------:| ---------:| --------:| ---------:| ---------:|
|  k[Ti L3-M1 + 6 others, Ti] |   0.02028 |  0.001823 |    1.008 |    0.0167 |   0.01943 |  0.02009 |   0.02091 |   0.02461 |
|   k[O K-L3 + 1 other, SiO2] |    0.4887 |  0.001071 |    1.589 |    0.4863 |     0.488 |   0.4885 |    0.4894 |    0.4903 |
| k[Fe L3-M5 + 11 others, Fe] | 6.728e-05 | 9.366e-05 | 0.009259 |         0 |         0 |        0 | 0.0001224 | 0.0002456 |
| k[Zn L3-M5 + 11 others, Zn] |   0.06806 | 0.0001951 |    1.321 |    0.0678 |   0.06789 |  0.06802 |   0.06813 |   0.06843 |
| k[Ge L3-M5 + 11 others, Ge] |    0.1795 | 0.0002331 |    1.318 |    0.1791 |    0.1793 |   0.1795 |    0.1797 |    0.1799 |
|    k[Al K-L3 + 1 other, Al] |   0.02808 | 7.824e-05 |    1.563 |   0.02796 |   0.02802 |  0.02808 |   0.02815 |   0.02819 |
|   k[Si K-L3 + 2 others, Si] |   0.02148 | 6.205e-05 |    1.237 |   0.02135 |   0.02145 |   0.0215 |   0.02153 |   0.02156 |
| k[Ca K-L3 + 3 others, CaF2] |    0.1214 | 0.0002119 |    1.255 |    0.1209 |    0.1213 |   0.1214 |    0.1215 |    0.1216 |
|   k[Ti K-L3 + 3 others, Ti] |   0.06401 | 0.0001365 |    1.322 |   0.06378 |   0.06394 |  0.06402 |   0.06408 |   0.06433 |
|    k[Fe K-L3 + 1 other, Fe] | 0.0003043 | 7.438e-05 |    1.069 | 0.0001826 | 0.0002744 | 0.000302 | 0.0003328 | 0.0004916 |
|   k[Fe K-M3 + 3 others, Fe] |  0.001002 | 0.0005511 |   0.1604 |         0 | 0.0007191 | 0.001213 |  0.001411 |  0.001759 |
|    k[Zn K-L3 + 1 other, Zn] |    0.1114 | 0.0002374 |   0.8712 |     0.111 |    0.1112 |   0.1115 |    0.1116 |    0.1117 |
|   k[Zn K-M3 + 3 others, Zn] |    0.1226 |   0.00254 |    1.619 |    0.1171 |    0.1221 |    0.123 |     0.124 |     0.126 |
|    k[Ge K-L3 + 1 other, Ge] |    0.2629 | 0.0007433 |    1.415 |    0.2614 |    0.2624 |   0.2632 |    0.2634 |     0.264 |
|   k[Ge K-M3 + 3 others, Ge] |    0.2756 |   0.00295 |     1.55 |     0.271 |    0.2732 |   0.2763 |     0.278 |    0.2805 |


```julia
@btime fit_spectrum(unks[1], frs)
```

```
1.675 ms (6580 allocations: 1.15 MiB)
ADM-6005a_1
```


